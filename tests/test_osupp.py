from osupp.core import init_osu_tools

init_osu_tools(r"C:\Users\bobbycyl\Projects\osu-tools\PerformanceCalculator\bin\Release\net8.0")

from osupp.difficulty import calculate_osu_difficulty
from osupp.performance import calculate_osu_performance
import orjson


def test():
    beatmap_path = r"C:\Users\bobbycyl\Projects\osu-tools\PerformanceCalculator\bin\Release\net8.0\cache\3477131.osu"
    mods = ["HD", "DT"]
    mod_options = ["DT_speed_change=1.3"]
    diff_result = '{"star_rating":8.340159453660592,"max_combo":1782,"aim_difficulty":4.464371148872465,"aim_difficult_slider_count":229.3534837920631,"speed_difficulty":3.5505915358962152,"speed_note_count":322.6236688454787,"slider_factor":0.9672502717561137,"aim_top_weighted_slider_factor":0.455429594945989,"speed_top_weighted_slider_factor":0.4901857094088748,"aim_difficult_strain_count":155.50956192853607,"speed_difficult_strain_count":91.93918738759285,"nested_score_per_object":27.145174371451745,"legacy_score_base_multiplier":4.0,"maximum_legacy_combo_score":52235232.0}'.encode()
    perf_result = '{"beatmap_info":{"DifficultyName":"Expert","Ruleset":{"ShortName":"osu","OnlineID":0,"Name":"osu!","InstantiationInfo":"osu.Game.Rulesets.Osu.OsuRuleset, osu.Game.Rulesets.Osu","LastAppliedDifficultyVersion":0,"Available":true},"Difficulty":{"DrainRate":5.0,"CircleSize":4.0,"OverallDifficulty":9.0,"ApproachRate":9.5,"SliderMultiplier":2.4,"SliderTickRate":1.0,"Parent":null},"Metadata":{"Title":"Storyteller","title_unicode":"Storyteller","Artist":"TRUE","artist_unicode":"TRUE","Author":{"OnlineID":1,"Username":"IOException","CountryCode":"Unknown","CountryString":"Unknown","IsBot":false,"Parent":null},"Source":"転生したらスライムだった件 第2期","tags":"TenSura 転スラ slime isekai That Time I Got Reincarnated as a Slime Season 2 Second 2nd Tensei shitara Slime suraimu Datta Ken Opening Rimuru Tempest リムル＝テンペスト Mikami Satoru Japanese Anime 唐沢 美帆","UserTags":[],"PreviewTime":46928,"AudioFile":"audio.mp3","BackgroundFile":"background.jpg"},"UserSettings":{"Offset":0.0,"Parent":null},"BeatmapSet":{"OnlineID":1701699,"DateAdded":"0001-01-01T00:00:00+00:00","DateSubmitted":null,"DateRanked":null,"Beatmaps":[],"Files":[],"Status":-3,"StatusInt":-3,"DeletePending":false,"Hash":"","Protected":false,"MaxStarDifficulty":0.0,"MaxLength":0.0,"MaxBPM":0.0,"AllBeatmapsUpToDate":true},"File":null,"Status":-3,"StatusInt":-3,"OnlineID":3477131,"Length":0.0,"BPM":0.0,"Hash":"","StarRating":-1.0,"MD5Hash":"","OnlineMD5Hash":"","LastLocalUpdate":null,"LastOnlineUpdate":null,"MatchesOnlineVersion":true,"EndTimeObjectCount":-1,"TotalObjectCount":-1,"LastPlayed":null,"BeatDivisor":4,"EditorTimestamp":null,"Path":null,"OnlineInfo":null,"MaxCombo":null},"performance_attributes":{"aim":174.73109835635245,"speed":65.9287498902982,"accuracy":75.88045126391914,"flashlight":0.0,"effective_miss_count":2.0,"speed_deviation":19.02604166245195,"combo_based_estimated_miss_count":2.0,"score_based_estimated_miss_count":null,"aim_estimated_slider_breaks":0.0,"speed_estimated_slider_breaks":0.0,"pp":329.88507381066114},"difficulty_attributes":{"star_rating":6.5573244947961955,"max_combo":1782,"aim_difficulty":3.5558149089835958,"aim_difficult_slider_count":212.31669845952544,"speed_difficulty":2.7088692600431186,"speed_note_count":293.2978143642428,"slider_factor":0.9665365858109283,"aim_top_weighted_slider_factor":0.4435754833342557,"speed_top_weighted_slider_factor":0.43512697356246866,"aim_difficult_strain_count":134.77529861943125,"speed_difficult_strain_count":84.41053188379207,"nested_score_per_object":27.145174371451745,"legacy_score_base_multiplier":4.0,"maximum_legacy_combo_score":52235232.0}}'.encode()
    assert orjson.dumps(calculate_osu_difficulty(beatmap_path, mods, mod_options)) == diff_result
    assert orjson.dumps(calculate_osu_performance(beatmap_path, combo=706, misses=2, mehs=4, oks=34, large_tick_misses=0, slider_tail_misses=7)) == perf_result
    assert orjson.dumps(calculate_osu_performance(beatmap_path, combo=706, misses=2, mehs=4, oks=34, large_tick_hits=57, slider_tail_hits=485)) == perf_result
